<!DOCTYPE html><head><meta charset="UTF-8"><title>s3c_minute</title></head><body><p>
**********************************************************************
<br/>
セッションs3c
<br/>
テーマ：mrubyの省メモリ化について考える
<br/>
講師: まつもと ゆきひろ, 高橋 征義, 山根 ゆりえ
<br/>
日時：8/31(金) 10:25-11:15
<br/>
参加人数：約20人
<br/>
**********************************************************************
<br/>

<br/>
■セッション内容
<br/>
背景: 
<br/>
	マイコン上でmruby動かしたい→省メモリ化必要
<br/>

<br/>
	mrb_open()のなかでやっている初期化部分を最適化したい
<br/>
	従来Rubyとして考えていなかったのは、初期化と実行の区別が少ないから。
<br/>

<br/>
	事前に決定している情報はROMに配置して、
<br/>
	実行時に使うRAM上の情報と切り替えて使う。
<br/>
	ROMに入れた情報
<br/>
	- ソースに埋め込まれているシンボルを検出して入れた
<br/>
	- メソッド表
<br/>

<br/>
今後やりたいこと
<br/>
	- RClass, irepをROMに入れたい 
<br/>
	- （そもそも）RAMに置く情報を減らす
<br/>

<br/>
	irepは現在進行形でROMにおける部分は置こうとしている、
<br/>
	RClassは入れられないのではないかと思っている
<br/>

<br/>
	RClassのROM化: 
<br/>
		クラスをfreezeしたことにすれば可能？？ 
<br/>
			→ 数10バイトのためにポインタを結局配置し
<br/>
			　　直したりするのでコスパが悪い
<br/>
	irepのスリム化: 
<br/>
		デバッグのための情報を減らせるようにする？
<br/>
			→ mruby/cではRAMに乗せる前提だったのですでに最小化されており、
<br/>
				逆にROM化は難しい。mrubyの方ができる可能性はある。
<br/>

<br/>
その他に考えていること
<br/>

<br/>
	バイトコード化: 
<br/>
        1バイト目が命令の種別になる
<br/>
        オペランドは3つまで。
<br/>
		オペランドが3つある場合、各オペランドは1バイトのメモリを指している
<br/>
		256で収まらない場合はOP_EXTnというprefixをつけると16bitにできる、という拡張をしている。
<br/>

<br/>
	khashのTree化: 
<br/>
		mrubyは挿入順の線形探索だが、
<br/>
		mruby/cは2分探索できるようにソートしてあってO(n)で挿入できる
<br/>

<br/>

<br/>
■質疑応答
<br/>

<br/>
	質: 
<br/>
		バイトコード化について、可変長オペランドは無理なのか。
<br/>
	まつもと > 
<br/>
		現状は3つ、設計上も拡張するのは難しいかも
<br/>

<br/>

<br/>
	質: 
<br/>
		ROMにあまりおいてないのはなぜ。
<br/>
	まつもと > 
<br/>
		Rubyの言語的な性質であまり問題になってなかったから。
<br/>
		Ruby本来の指向が変わらないのであれば、
<br/>
		今後は改善していこうとしている。
<br/>

<br/>

<br/>
	質: 
<br/>
		初期化時では、実行するときに、1回目の情報を再利用して、2回目は変更点と
<br/>
		かだけを動的にすれば少し早くなるのでは。
<br/>
	山根 > 
<br/>
		mruby開発者としては、一番最初の初期化は時間かかっても大丈夫なのかな？
<br/>
		というところから、とりあえずRAM使うのを小さくするというための
<br/>
		取り組みだった
<br/>
	質 > 
<br/>
		要求によるけど、1回目ならという許容が発生したりするかも。
<br/>

<br/>

<br/>
	質: 
<br/>
		そもそもROM化する要求はどこからきてる？
<br/>
	まつもと > 
<br/>
		ROMは潤沢でも、RAMは少なかったりする。
<br/>
	山根 > 
<br/>
		安いマイコンだとしんどかったりして、動かなかった経験
<br/>

<br/>
	質: 
<br/>
		edge化して他のリッチなホストで動かすとかはだめなのか
<br/>
	まつもと > 
<br/>
		そもそもmrubyの対象は組込みからすると結構リッチだったのだが、
<br/>
        それでもちょっと大きめのものだとメモリが足りません、ということがあり、
<br/>
		もっと小さくとかっていう要求が出てきた
<br/>

<br/>
	質: Cのコンパイルでは、シンボルにread only, 
<br/>
		書き換え可能, 初期値があるなどの属性がついてるけど、Rubyはどうなってるのか？
<br/>
	まつもと > 
<br/>
		Rubyでもシンボルなどは書き変わらないので、その配置を工夫することはでき、そのpull requestが来てる
<br/>

<br/>

<br/>
■まとめ
<br/>
	mrubyの省メモリ化をするために、現在行っている取り組みおよび今後の対応できる
<br/>
	可能性に関して発表が行われた。
<br/>
	その発表をもとにmrubyを実際に使っている参加者からも、
<br/>
	複数の質問や提案が行われ活発な議論となった。
<br/>

<br/>

<br/>
以上。
<br/>
</p></body>
